{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>StudyARC ClassPad Main</title>
    <link rel="stylesheet" href="{% static 'maths/classpad.css' %}">
</head>
<body>

<div class="cp-wrapper">
    <div class="cp-device">
        <!-- Zone A: Status bar -->
        <div class="cp-status-bar">
            <div class="cp-status-left">
                <div class="cp-status-toggle active" data-group="mode" data-value="Alg">Alg</div>
                <div class="cp-status-toggle" data-group="mode" data-value="Assist">Assist</div>

                <div class="cp-status-toggle active" data-group="format" data-value="Std">Std</div>
                <div class="cp-status-toggle" data-group="format" data-value="Dec">Dec</div>

                <div class="cp-status-toggle active" data-group="num" data-value="Real">Real</div>
                <div class="cp-status-toggle" data-group="num" data-value="Cplx">Cplx</div>

                <div class="cp-status-toggle active" data-group="angle" data-value="Rad">Rad</div>
                <div class="cp-status-toggle" data-group="angle" data-value="Deg">Deg</div>
            </div>

            <div class="cp-status-right">
                <div class="cp-battery">
                    <div class="cp-battery-fill"></div>
                </div>
            </div>
        </div>

        <!-- Zone B: Menu bar -->
        <div class="cp-menu-bar">
            <div class="cp-menu-item">Edit</div>
            <div class="cp-menu-item">Action</div>
            <div class="cp-menu-item">Interactive</div>
            <div class="cp-layout-toggle">0.5×</div>
        </div>

        <!-- Zone C: Icon toolbar -->
        <div class="cp-icon-toolbar">
            <button class="cp-icon-button" id="cp-clear-line">CLR</button>
            <button class="cp-icon-button" data-insert="( )/( )">a/b</button>
            <button class="cp-icon-button" data-insert="sqrt( )">√</button>
            <button class="cp-icon-button" data-insert="^2">x²</button>
            <button class="cp-icon-button" data-insert="^">x^□</button>
            <button class="cp-icon-button" data-insert="abs( )">|x|</button>
            <button class="cp-icon-button" data-insert="->">⇒</button>
            <button class="cp-icon-button" id="cp-graph">Graph</button>
        </div>

        <!-- Zone D: main area -->
        <div class="cp-main">
            <div class="cp-workspace" id="cp-workspace">
                <!-- Initial input line -->
                <div class="cp-line cp-line-input" data-line-type="input">
                    <div class="cp-bullet">■</div>
                    <div class="cp-input-content" id="cp-current-input" contenteditable="true"></div>
                </div>
                <div class="cp-placeholder">Type an expression and press EXE.</div>
            </div>

            <!-- Virtual keyboard -->
            <div class="cp-keyboard">
                <!-- Tabs -->
                <div class="cp-keyboard-tabs">
                    <div class="cp-tab active" data-tab="math1">Math1</div>
                    <div class="cp-tab" data-tab="math2">Math2</div>
                    <div class="cp-tab" data-tab="trig">Trig</div>
                    <div class="cp-tab" data-tab="var">Var</div>
                    <div class="cp-tab" data-tab="abc">abc</div>
                </div>

                <!-- Tab bodies -->
                <div class="cp-keyboard-body active" id="tab-math1">
                    <div class="cp-key" data-insert="( )/( )">a/b</div>
                    <div class="cp-key" data-insert="sqrt( )">√</div>
                    <div class="cp-key" data-insert="^2">x²</div>
                    <div class="cp-key" data-insert="^">x^□</div>

                    <div class="cp-key" data-insert="pi">π</div>
                    <div class="cp-key" data-insert="e">e</div>
                    <div class="cp-key" data-insert="x">x</div>
                    <div class="cp-key" data-insert="y">y</div>

                    <div class="cp-key" data-insert="+">+</div>
                    <div class="cp-key" data-insert="-">−</div>
                    <div class="cp-key" data-insert="*">×</div>
                    <div class="cp-key" data-insert="/">÷</div>

                    <div class="cp-key" data-insert="(">(</div>
                    <div class="cp-key" data-insert=")">)</div>
                    <div class="cp-key" data-insert=",">,</div>
                    <div class="cp-key" data-insert="ans">ans</div>

                    <div class="cp-key exec wide" data-action="exe">EXE</div>
                    <div class="cp-key wide" data-action="backspace">⌫</div>
                </div>

                <div class="cp-keyboard-body" id="tab-math2">
                    <div class="cp-key small" data-insert="matrix([[ , ],[ , ]])">2×2</div>
                    <div class="cp-key small" data-insert="lim_(x-> ) ">lim</div>
                    <div class="cp-key small" data-insert="diff( , x)">d/dx</div>
                    <div class="cp-key small" data-insert="integrate( , x)">∫dx</div>

                    <div class="cp-key small" data-insert="sum( , (x, , ))">Σ</div>
                    <div class="cp-key small" data-insert="prod( , (x, , ))">Π</div>
                    <div class="cp-key small" data-insert="det( )">det</div>
                    <div class="cp-key small" data-insert="tr( )">tr</div>

                    <div class="cp-key small" data-insert="solve( , x)">solve</div>
                    <div class="cp-key small" data-insert="taylor( , x, , )">taylor</div>
                </div>

                <div class="cp-keyboard-body" id="tab-trig">
                    <div class="cp-key" data-insert="sin( )">sin</div>
                    <div class="cp-key" data-insert="cos( )">cos</div>
                    <div class="cp-key" data-insert="tan( )">tan</div>
                    <div class="cp-key" data-insert="ln( )">ln</div>

                    <div class="cp-key small" data-insert="asin( )">sin⁻¹</div>
                    <div class="cp-key small" data-insert="acos( )">cos⁻¹</div>
                    <div class="cp-key small" data-insert="atan( )">tan⁻¹</div>
                    <div class="cp-key small" data-insert="exp( )">e^x</div>
                </div>

                <div class="cp-keyboard-body" id="tab-var">
                    <div class="cp-key" data-insert="a">a</div>
                    <div class="cp-key" data-insert="b">b</div>
                    <div class="cp-key" data-insert="c">c</div>
                    <div class="cp-key" data-insert="d">d</div>

                    <div class="cp-key" data-insert="m">m</div>
                    <div class="cp-key" data-insert="n">n</div>
                    <div class="cp-key" data-insert="k">k</div>
                    <div class="cp-key" data-insert="t">t</div>
                </div>

                <div class="cp-keyboard-body" id="tab-abc">
                    <div class="cp-key qwerty" data-insert="q">q</div>
                    <div class="cp-key qwerty" data-insert="w">w</div>
                    <div class="cp-key qwerty" data-insert="e">e</div>
                    <div class="cp-key qwerty" data-insert="r">r</div>
                    <div class="cp-key qwerty" data-insert="t">t</div>

                    <div class="cp-key qwerty" data-insert="y">y</div>
                    <div class="cp-key qwerty" data-insert="u">u</div>
                    <div class="cp-key qwerty" data-insert="i">i</div>
                    <div class="cp-key qwerty" data-insert="o">o</div>
                    <div class="cp-key qwerty" data-insert="p">p</div>

                    <div class="cp-key qwerty" data-insert="a">a</div>
                    <div class="cp-key qwerty" data-insert="s">s</div>
                    <div class="cp-key qwerty" data-insert="d">d</div>
                    <div class="cp-key qwerty" data-insert="f">f</div>
                    <div class="cp-key qwerty" data-insert="g">g</div>

                    <div class="cp-key qwerty" data-insert="h">h</div>
                    <div class="cp-key qwerty" data-insert="j">j</div>
                    <div class="cp-key qwerty" data-insert="k">k</div>
                    <div class="cp-key qwerty" data-insert="l">l</div>

                    <div class="cp-key qwerty wide" data-insert=" ">Space</div>
                    <div class="cp-key qwerty" data-action="backspace">⌫</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function getCurrentInput() {
        return document.getElementById("cp-current-input");
    }

    function setCursorToEnd(el) {
        if (!el) return;
        const range = document.createRange();
        const sel = window.getSelection();
        range.selectNodeContents(el);
        range.collapse(false);
        sel.removeAllRanges();
        sel.addRange(range);
        el.focus();
    }

    function insertAtEnd(text) {
        const input = getCurrentInput();
        if (!input) return;
        input.textContent += text;
        setCursorToEnd(input);
    }

    function createNewInputLine() {
        const workspace = document.getElementById("cp-workspace");
        const placeholder = workspace.querySelector(".cp-placeholder");
        if (placeholder) placeholder.remove();

        const line = document.createElement("div");
        line.className = "cp-line cp-line-input";
        line.setAttribute("data-line-type", "input");

        const bullet = document.createElement("div");
        bullet.className = "cp-bullet";
        bullet.textContent = "■";

        const content = document.createElement("div");
        content.className = "cp-input-content";
        content.id = "cp-current-input";
        content.contentEditable = "true";

        line.appendChild(bullet);
        line.appendChild(content);
        workspace.appendChild(line);
        workspace.scrollTop = workspace.scrollHeight;
        setCursorToEnd(content);
    }

    function addOutputLine(resultText) {
        const workspace = document.getElementById("cp-workspace");
        const line = document.createElement("div");
        line.className = "cp-line cp-line-output";
        line.setAttribute("data-line-type", "output");

        const content = document.createElement("div");
        content.className = "cp-output-content";
        content.textContent = resultText;

        line.appendChild(content);
        workspace.appendChild(line);
        workspace.scrollTop = workspace.scrollHeight;
    }

    // Keyboard keys that insert text
    document.querySelectorAll(".cp-key[data-insert]").forEach(key => {
        key.addEventListener("click", () => {
            insertAtEnd(key.getAttribute("data-insert"));
        });
    });

    // Keyboard actions (EXE, backspace)
    document.querySelectorAll(".cp-key[data-action]").forEach(key => {
        key.addEventListener("click", () => {
            const action = key.getAttribute("data-action");
            const input = getCurrentInput();
            if (!input) return;

            if (action === "backspace") {
                input.textContent = input.textContent.slice(0, -1);
                setCursorToEnd(input);
            }

            if (action === "exe") {
                const expr = input.textContent.trim();
                if (!expr) return;

                // TODO later: call Django/SymPy endpoint instead of echo
                addOutputLine("= " + expr);

                input.removeAttribute("id");
                input.removeAttribute("contenteditable");

                createNewInputLine();
            }
        });
    });

    // Tabs
    document.querySelectorAll(".cp-tab").forEach(tab => {
        tab.addEventListener("click", () => {
            const name = tab.getAttribute("data-tab");
            document.querySelectorAll(".cp-tab").forEach(t => t.classList.remove("active"));
            tab.classList.add("active");

            document.querySelectorAll(".cp-keyboard-body").forEach(body => {
                body.classList.remove("active");
            });
            document.getElementById("tab-" + name).classList.add("active");
        });
    });

    // Status toggles (visual only)
    document.querySelectorAll(".cp-status-toggle").forEach(toggle => {
        toggle.addEventListener("click", () => {
            const group = toggle.getAttribute("data-group");
            if (!group) return;
            document.querySelectorAll('.cp-status-toggle[data-group="' + group + '"]')
                .forEach(t => t.classList.remove("active"));
            toggle.classList.add("active");
        });
    });

    // Clear and Graph toolbar buttons
    document.getElementById("cp-clear-line").addEventListener("click", () => {
        const input = getCurrentInput();
        if (input) {
            input.textContent = "";
            setCursorToEnd(input);
        }
    });

    document.getElementById("cp-graph").addEventListener("click", () => {
        alert("Graph placeholder – later hook this into your Django/SymPy graph engine.");
    });

    // Line selection highlight
    document.getElementById("cp-workspace").addEventListener("click", (e) => {
        const line = e.target.closest(".cp-line");
        document.querySelectorAll(".cp-line").forEach(l => l.classList.remove("selected"));
        if (line) line.classList.add("selected");
    });

    window.addEventListener("load", () => {
        setCursorToEnd(getCurrentInput());
    });
</script>

</body>
</html>
