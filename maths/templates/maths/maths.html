{% extends "base.html" %}
{% load static %}

{% block title %}Math Solver - StudyARC{% endblock %}

{% block exthead %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="{% static 'maths/css/mathquill.min.css' %}">
<script src="{% static 'maths/js/mathquill.min.js' %}"></script>

<style>
.math-input-box {
    border: 1px solid #ccc;
    padding: 10px;
    min-height: 40px;
    font-size: 20px;
    border-radius: 6px;
    background: white;
    margin-bottom: 10px;
}
.result-box {
    background: #f5f5f5;
    padding: 12px;
    border-radius: 6px;
    margin-top: 10px;
}
.button-bar {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}
.mq-btn {
    padding: 6px 12px;
    font-size: 15px;
    border-radius: 6px;
    border: 1px solid #888;
    background: #f2f2f2;
    cursor: pointer;
    color: black;
}
.mq-btn:hover {
    background: #e0e0e0;
}
.hint {
    font-size: 0.9em;
    color: #666;
    margin-top: 6px;
}
.kbd {
    font-family: ui-monospace, monospace;
    background: #eee;
    padding: 2px 6px;
    border-radius: 6px;
}
</style>
{% endblock %}

{% block content %}

<h1>Casio Classpad replica but better, {{ user.username }} üëã</h1>
<p>Welcome to the StudyARC symbolic equation solver.</p>

<div class="hint">
    Define functions using: <span class="kbd">def f(x)=x^2+1</span><br>
    Then use: <span class="kbd">f(3)</span>,
    <span class="kbd">diff(f(x))</span>,
    <span class="kbd">integrate(f(x),0,1)</span><br>
    Graph with: <span class="kbd">graph(f)</span>, <span class="kbd">graph(f(x))</span>,
    <span class="kbd">graph(f(x),g(x),-10,10)</span>
</div>

<form method="POST">
{% csrf_token %}

<label>Enter an equation / expression:</label>
<div id="math-field" class="math-input-box"></div>

<input type="hidden" id="math-latex" name="expression"
       value="{{ input_latex|default:'' }}">

<br><br>

<div class="button-bar">
    <button type="button" class="mq-btn" data-insert="\log">log</button>
    <button type="button" class="mq-btn" data-insert="\sqrt">‚àö</button>
    <button type="button" class="mq-btn" data-insert="\sqrt[]">n‚àö</button>
    <button type="button" class="mq-btn" data-insert="e">e</button>
    <button type="button" class="mq-btn" data-insert="\pi">œÄ</button>
    <button type="button" class="mq-btn" data-insert="\frac{}{}">a‚ÅÑb</button>
    <button type="button" class="mq-btn" data-insert="^">x ∏</button>
    <button type="button" class="mq-btn" data-insert=" ">space</button>
    <button type="button" class="mq-btn" data-insert="def\ ">def</button>
</div>

<br>

<label>Domain (for roots / inequalities):</label><br>
<input type="text" name="domain_min" value="{{ domain_min|default:'-oo' }}" style="width:80px;">
to
<input type="text" name="domain_max" value="{{ domain_max|default:'oo' }}" style="width:80px;">

<br><br>

<label>Output Format:</label>
<select name="format_mode">
    <option value="decimal" {% if format_mode == "decimal" %}selected{% endif %}>Decimal</option>
    <option value="standard" {% if format_mode == "standard" %}selected{% endif %}>Standard (Exact)</option>
</select>

<br><br>
<button type="submit">EXE</button>
</form>

<hr>

{% if error %}
<div class="result-box" style="color:red;">
<strong>Error:</strong> {{ error }}
</div>
{% endif %}

{% if direct_result %}
<div class="result-box">
<h2>Result</h2>
<p>{{ direct_result }}</p>
</div>
{% endif %}

{% if plot_data_json %}
<div class="result-box">
    <h2>Graph</h2>
    <div id="graphDiv" style="width:100%; height:420px;"></div>

    <script id="plotData" type="application/json">{{ plot_data_json|safe }}</script>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <script>
        const payload = JSON.parse(document.getElementById("plotData").textContent);

        const traces = payload.series.map(s => ({
            name: s.name,
            x: s.x,
            y: s.y,
            mode: "lines",
            connectgaps: false
        }));

        const layout = {
            margin: { t: 20, r: 20, b: 40, l: 50 },
            xaxis: { range: [payload.xmin, payload.xmax], zeroline: true },
            yaxis: { zeroline: true },
            legend: { orientation: "v" }
        };

        Plotly.newPlot("graphDiv", traces, layout, {responsive: true});
    </script>
</div>
{% endif %}

{% if solutions %}
<div class="result-box">
<h2>Solutions</h2>
<ul>
{% for s in solutions %}
<li>{{ s }}</li>
{% endfor %}
</ul>
</div>
{% endif %}

{% if general_solution %}
<div class="result-box">
<h2>General Solution</h2>
<p>{{ general_solution }}</p>
</div>
{% endif %}

{% if inequality_solution %}
<div class="result-box">
<h2>Inequality Solution</h2>
<p>{{ inequality_solution }}</p>
</div>
{% endif %}

{% if functions %}
<div class="result-box">
<h2>Defined Functions</h2>
<ul>
{% for name, data in functions.items %}
<li>{{ name }}({{ data.0 }}) = {{ data.1 }}</li>
{% endfor %}
</ul>
</div>
{% endif %}

<script src="{% static 'maths/js/casio.js' %}"></script>
{% endblock %}
